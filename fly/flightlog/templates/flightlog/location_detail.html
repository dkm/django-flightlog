{% extends "flightlog/base.html" %}

{% block extrahead %}
     <script src="http://openlayers.org/api/OpenLayers.js"></script>
     <style type="text/css">
             #output { width: 100%; height: 300px}
    </style>

{% endblock %}

{% block title %}Location details for {{ location }} {% endblock %}
{% block content %}
{{ location }}
<a href="/location/edit/{{location.id}}">[edit]</a><a href="/location/del/{{location.id}}">[del]</a>

<table>
  <tr>
    <td>Geographic location:</td>
    <td>
<script type="text/javascript">
//<![CDATA[
       var map, layer, wkt, features, options, formats;
       var src = new OpenLayers.Projection('EPSG:4326'); 
       var dest = new OpenLayers.Projection('EPSG:900913');
       
       function updateFormats() { 
            formats = {
              'in': {
                wkt: new OpenLayers.Format.WKT(),
                geojson: new OpenLayers.Format.GeoJSON(),
                georss: new OpenLayers.Format.GeoRSS(),
                gml: new OpenLayers.Format.GML(),
                kml: new OpenLayers.Format.KML()
              }, 
              'out': {
                wkt: new OpenLayers.Format.WKT(),
                geojson: new OpenLayers.Format.GeoJSON(),
                georss: new OpenLayers.Format.GeoRSS(),
                gml: new OpenLayers.Format.GML(),
                kml: new OpenLayers.Format.KML()
              } 
            };
        serialize()
        }
       
        function serialize() {
            if (vectors.selectedFeatures.length == 1) {
            var feature = vectors.selectedFeatures[0].clone()
            var type = document.getElementById("formatType").value;
            var proj = document.getElementById("outproj").value;
            if (proj == "EPSG:4326") {
               feature.geometry.transform(dest,src);
               }
            var str = formats['out'][type].write(feature);
            str = str.replace(/,/g, ', ');
            document.getElementById('output').value = str;
            } else {document.getElementById('output').value = ''}
        }
         
       function init(){
       var options = {
           'projection' : new OpenLayers.Projection("EPSG:900913"),
           'numZoomLevels' : 20,
           'displayProjection' : new OpenLayers.Projection("EPSG:4326"),
           'units' : "m",
           'maxResolution' : 156543.0339,
           'maxExtent' : new OpenLayers.Bounds(-20037508,-20037508,20037508,20037508)
       }
       map = new OpenLayers.Map( 'map', options );
       layer = new OpenLayers.Layer.OSM("OpenStreetMap (Mapnik)");
       map.addLayer(layer);
       map.addControl(new OpenLayers.Control.MousePosition());
       vectors = new OpenLayers.Layer.Vector("Vector Layer");
       wkt = new OpenLayers.Format.WKT();
       features = wkt.read('{{ location.coord }}');
       features.geometry.transform(src, dest);
       vectors.addFeatures([features]);
       map.addLayer(vectors);
       map.zoomToExtent(features.geometry.getBounds());
       if (map.getZoom() > 13) {
        map.zoomTo(13);
       }
       map.getControlsByClass('OpenLayers.Control.Navigation')[0].disableZoomWheel();
       var select_options = {
            hover: false,
            onSelect: serialize,
            onUnselect: serialize,
       };
       var select = new OpenLayers.Control.SelectFeature(vectors, select_options);
       map.addControl(select);
       select.activate();
       updateFormats();
       }
//]]>
</script>
<div id="map" style="width: 800px; height: 400px;"></div>

<script type="text/javascript">init();</script>
    </td>
  </tr>
</table>

<p>
5 Last flights starting from here:
<ul>
  {% for flight in takeoff %}
   <li><a href="/flight/view/{{flight.id}}">{{flight}}</a></li>
  {% empty %}
 <li>None...</li>
  {% endfor %}
</ul>
5 last flights ending here:
<ul>
  {% for flight in landing %}
   <li><a href="/flight/view/{{flight.id}}">{{flight}}</a></li>
  {% empty %}
 <li>None...</li>
  {% endfor %}
</ul>
</p>
{% endblock %}
